<!DOCTYPE html>
<html lang="en">
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="/community/js/jquery3.4.1.js"></script>
</head>

<body>


<div id="message" class="chat-box" style="overflow-y:scroll;"></div>
<textarea  placeholder="请输入信息" class="chat-bot" id="text" ></textarea>


</body>
<script type="text/javascript">
    var websocket = null;
    var val = $("#userId").val();
    var toUserId
    var fromUserId
    /**
     * 访问网页时自动连接
     */
    window.onload = function(){
        //发送者id
        fromUserId = sessionStorage.getItem("fromUserId");
        //接收者id
        toUserId = sessionStorage.getItem("toUserId");

        console.log(fromUserId);
        console.log(toUserId)
        this.connectWebSocket()
        $.ajax({
            url:'/community/chatHistory',
            method:'get',
            data:{
                "fromUser":fromUserId,
                "toUser":toUserId
            },
            success(res){
                console.log(res)
                res.forEach(function(item,index){
                    console.log(item)
                    this.setMessageInnerHTML(item.fromUserName+' : '+item.msg)
                })
            }

        })

    }

    function connectWebSocket() {
        //判断当前浏览器是否支持WebSocket
        if ('WebSocket' in window) {
            websocket = new WebSocket("ws://localhost:9000/community/websocket/"+fromUserId);
        } else {
            alert('Not support websocket')
        }
        //连接发生错误的回调方法
        websocket.onerror = function () {
            setMessageInnerHTML("error");
        };
        //连接成功建立的回调方法
        websocket.onopen = function (event) {
            setMessageInnerHTML("Loc MSG: 成功建立连接");
        }
        //接收到消息的回调方法
        websocket.onmessage = function (event) {
            console.log(event)
            setMessageInnerHTML(event.data);
        }
        //连接关闭的回调方法
        websocket.onclose = function () {
            setMessageInnerHTML("Loc MSG:关闭连接");
        }
        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function () {
            this.closeWebSocket()
        }
    }

    //将消息显示在网页上
    function setMessageInnerHTML(innerHTML) {
        document.getElementById('message').innerHTML += innerHTML + '<br/>';
    }

    //关闭连接
    function closeWebSocket() {
        websocket.close();
    }

    $("#text").keyup(function (e) {
        if (e.keyCode == 13){
            send()
            $("#text").val('');
        }
    })
    //发送消息
    function send() {
        let msg = $("#text").val();
        var flag = 0;
        var timestamp = (new Date()).getTime();
        var chat = {fromUserId:fromUserId,toUserId:toUserId,msg:msg,time:timestamp,flag:flag}
        websocket.send(JSON.stringify(chat));
    }
</script>
<style>
    .chat-box{
        width: 50%;
        height: 300px;
        margin-top: 40px;
        border: 1px solid gray;
        padding: 10px;
    }
    .chat-bot{
        width: 50%;
        height: 80px;
        border: 1px solid gray;
        padding: 10px;
    }
</style>
</html>